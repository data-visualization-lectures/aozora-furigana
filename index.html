<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>青空文庫ルビ削除ツール</title>
    <link rel="stylesheet" href="/static/style.css" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RHY5K5CZHV"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-RHY5K5CZHV");
    </script>
  </head>
  <body>
    <main>
      <h1>青空文庫ルビ削除ツール</h1>
      <p class="hint">
        <a href="https://www.aozora.gr.jp/" target="_blank">青空文庫</a>の作品ページで「テキストファイル(ルビあり)」のZIPリンクをコピーし、下に貼り付けてください。
      </p>
      <p class="sample">
        例：<a href="https://www.aozora.gr.jp/cards/000081/card456.html" target="_blank">銀河鉄道の夜</a> https://www.aozora.gr.jp/cards/000081/files/456_ruby_145.zip
      </p>

      <form id="convert-form" class="controls">
        <input
          type="url"
          id="zip-url"
          placeholder="ZIPファイルのURL"
          required
        />
        <div class="button-group">
          <button type="submit" id="convert-btn">ルビを削除</button>
          <button type="button" id="clear-btn" class="secondary">入力をクリア</button>
        </div>
      </form>

      <div id="error-box" class="error hidden"></div>

      <section id="result-section" class="hidden">
        <h2>変換結果</h2>
        <textarea id="result-text" readonly></textarea>
        <div class="download-box">
          <button type="button" id="download-btn">テキストをダウンロード</button>
        </div>
      </section>
    </main>
    <footer class="site-footer">
      <a href="https://www.dataviz.jp/" target="_blank" rel="noopener">
        Dataviz.JP
      </a>
      <span class="divider">/</span>
      <a href="https://visualizing.jp/" target="_blank" rel="noopener">
        Visualizing.JP
      </a>
    </footer>
    <script>
      const form = document.getElementById("convert-form");
      const zipInput = document.getElementById("zip-url");
      const convertBtn = document.getElementById("convert-btn");
      const clearBtn = document.getElementById("clear-btn");
      const errorBox = document.getElementById("error-box");
      const resultSection = document.getElementById("result-section");
      const resultText = document.getElementById("result-text");
      const downloadBtn = document.getElementById("download-btn");
      let latestText = "";

      const showError = (msg) => {
        if (!msg) {
          errorBox.classList.add("hidden");
          errorBox.textContent = "";
          return;
        }
        errorBox.textContent = msg;
        errorBox.classList.remove("hidden");
      };

      const showResult = (text) => {
        latestText = text;
        resultText.value = text;
        if (text) {
          resultSection.classList.remove("hidden");
        } else {
          resultSection.classList.add("hidden");
        }
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const url = zipInput.value.trim();
        if (!url) {
          showError("ZIPファイルのURLを入力してください。");
          return;
        }

        showError("");
        showResult("");
        convertBtn.disabled = true;
        convertBtn.textContent = "変換中...";

        try {
          const response = await fetch("/api/convert", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ url }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "変換に失敗しました。");
          }
          showResult(data.text || "");
        } catch (error) {
          showError(error.message);
        } finally {
          convertBtn.disabled = false;
          convertBtn.textContent = "ルビを削除";
        }
      });

      clearBtn.addEventListener("click", () => {
        zipInput.value = "";
        showError("");
        showResult("");
      });

      downloadBtn.addEventListener("click", () => {
        if (!latestText) return;
        const blob = new Blob([latestText], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "aozora_cleaned.txt";
        link.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
